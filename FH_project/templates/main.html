{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <title>Food Helper | Profile</title>
    <link rel="stylesheet" href="{% static "main.css" %}">
</head>
<body>
    <header class="header_main">
        <div class="contaner">
            <div class="header-box">
                <h1>Помощник по питанию</h1>
                <a href="#" id="logout_btn" class="logout_btn">Выйти</a>
            </div>
        </div>
    </header>
    <section class="info_main">
        <div class="contaner">
            <div class="main_block">
                <div class="main_info">
                    <div class="personal_info">
                        <div class="personal_photo">
                            <img src="{% static "img/photo.svg" %}" alt="">
                            <button class="main-btns"><img src="{% static "img/dice.svg" %}" alt=""></button>
                        </div>
                        <div class="personal_info_block" id="profile">
                            <h2 id="username"></h2>
                            <div class="personal_info_subblock">
                                <p>Email</p>
                                <span id="email"></span>
                                <input type="text" id="email-input" class="edit-input">
                            </div>
                            <div class="personal_info_subblock">
                                <p>Пол</p>
                                <span id="gender"></span>
                                <input type="text" id="gender-input" class="edit-input">
                            </div>
                            <div class="personal_info_subblock">
                                <p>Дата рождения</p>
                                <span id="date_of_birth"></span>
                                <input type="date" id="date_of_birth-input" class="edit-input">
                            </div>
                            <div class="personal_info_subblock">
                                <p>Рост</p>
                                <span id="height"></span>
                                <input type="number" id="height-input" class="edit-input">
                                <p>Вес</p>
                                <span id="weight"></span>
                                <input type="number" id="weight-input" class="edit-input">
                            </div>
                            <div class="personal_info_subblock">
                                <p>Образ питания</p>
                                <span id="vegan_vegetarian"></span>
                                <input type="text" id="vegan_vegetarian-input" class="edit-input" value="Вегетарианец">
                            </div>
                            <div class="personal_info_subblock">
                                <p>Нежелательные продукты</p>
                                <span id="allergies"></span>
                                <input type="text" id="allergies-input" class="edit-input" value="Орехи">
                            </div>
                            <div class="personal_info_subblock">
                                <p>Цель</p>
                                <span id="goal"></span>
                                <input type="text" id="goal-input" class="edit-input" value="Похудение">
                            </div>
                            <div class="personal-info-btns">
                                <button type="button" class="main-links" id="recovery-password-btn">Сменить пароль</button>
                                <button class="edit-info-btn" id="edit-info-btn">Редактировать</button>
                                <button class="save-info-btn" id="save-info-btn">Сохранить</button>
                                <button class="cancel-edit-btn" id="cancel-edit-btn">Отменить</button>
                            </div>
                        </div>
                    </div>
                    <div class="food_info">
                        <h3>История за день</h3>
                        <span class="food-date" id="currentDate">Дата</span>
                        <div class="food-main">
                            <div class="food-info-headers">
                                <h4>Тип приема пищи</h4>
                                <h4>Время</h4>
                                <h4>Оценка</h4>
                            </div>
                            <div class="food-add-info">
                    
                            </div>
                            <div class="input-area">
                                <button class = "list-add-btn" id="addMealButton"> <img src="{% static "img/addWord.svg" %}" alt="">Добавить приём пищи</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chat-block" id="chatBlock">
                    <div class = "chat-window">
                        <div class="chat-content">
                            <div class="chat-header">
                                <h1>A.I. Food Helper</h1>
                            </div>
                            <div class="chat-input-content">
                                <div class="chat-input-content-btns">
                                    <button type="button" onclick="location.href='{% url 'main:new_chat' %}'">Очистить чат</button>
                                </div>
                                <div class="chat-message-wrapper">
                                {% for message in messages %}
                                    <div class="card mb-2 {% if message.role == 'assistant' %}bg-success text-white{% endif %}">
                                        <div class="card-body p-2">
                                            <strong>{{ message.role|title }}:</strong> {{ message.content|linebreaksbr }}
                                        </div>
                                    </div>
                                {% endfor %}
                                </div>
                                <form action="." method="POST">
                                    {% csrf_token %}
                                    <input required type="text" autofocus="autofocus" name="prompt" value="{{ prompt }}" id="">
                                    <input type="hidden" name="additional_text" id="additional_text_input" value="">
                                    <button type="submit">
                                            ОТПРАВИТЬ
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>


                <div class="food_add_info" id="foodAddInfo">
                    <h2>Добавление приёма пищи</h2>
                    <div class="add-meal-block-headers">
                        <h4>Тип приёма пищи</h4>
                        <button class="main-links" id="addMealTimeButton">Выбрать</button>
                        <form class="add-form" id="addMealForm">
                            <div class="__select" data-state="">
                                <div class="__select__title" data-default="Option 0">Завтрак</div>
                                <div class="__select__content">
                                  <input id="singleSelect0" class="__select__input" type="radio" name="singleSelect" value="Завтрак"checked />
                                  <label for="singleSelect0" class="__select__label">Завтрак</label>
                                  <input id="singleSelect1" class="__select__input" type="radio" name="singleSelect" value="Завтрак"/>
                                  <label for="singleSelect1" class="__select__label">Завтрак</label>
                                  <input id="singleSelect2" class="__select__input" type="radio" name="singleSelect" value="Обед"/>
                                  <label for="singleSelect2" class="__select__label">Обед</label>
                                  <input id="singleSelect3" class="__select__input" type="radio" name="singleSelect" value="Ужин"/>
                                  <label for="singleSelect3" class="__select__label">Ужин</label>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="add-meal-block-headers">
                        <h4>Время</h4>
                        <button class="main-links" id="setTimeButton">00:00</button>
                        <form class="add-form" id="addTimeForm">
                            <div class="set-time-block">
                                <p>
                                    <input class="set-time-input" type="time" id="time" name="time"/>
                                </p>
                                <p>
                                    <button type="button" class="submit-time-btn">Принять</button>
                                </p>
                            </div>
                        </form>
                    </div>
                    <div class="form-wrapper">
                        <h3>Употребленные продукты</h3>
                        <div class="type-of-food-block">
                            <div class="type-of-food-block-headers">
                                <h4>Наименование</h4>
                                <h4>Кол-во</h4>
                            </div>
                            <div class="string-list" id="stringList"></div>                  
                            <div class="input-area">
                                <button class = "list-add-btn" id="showInputButton"> <img src="{% static "img/addWord.svg" %}" alt="">Добавить съеденную пищу</button>
                                <div class="textInputContainer" id="textInputContainer">
                                    <input type="text" class="inputField" id = "newInput2" placeholder="Введите слово">
                                    <button class="addButton" id = "newButton">Добавить</button>
                                </div>
                            </div>
                            <input type="text" class="inputField" id = "newInput" placeholder="Введите слово">

                            <input type="number" id="quantity" name="quantity" required>
                        </div>
                        <div class="results-btn-block">
                            <button class="results-btn" id="resultsBtn">Получить оценку</button>
                        </div>
                    </div>

                    <div class="results-block">
                        <h3>Оценка</h3>
                        <div class="result-list">
                            <ol>
                                <li><div class="result-list-item">
                                    <div class="name-of-product-result">
                                        <p>Кузя лакомкин</p>
                                        <h5>0/10</h5> <!--Оценка отдельного продукта-->
                                    </div>
                                <span>Комментарий</span> <!--Комментарий-->
                                </div></li>
                            </ol>
                        </div>
                        <h3 id="overallResult"></h3> <!--Общая оценка-->
                    </div>
                </div>
            </div>
        </div>
    </section>




    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('resultsBtn').addEventListener('click', function() {
                const token = localStorage.getItem('token');
                const mealType = document.querySelector('input[name="singleSelect"]:checked').value;
                const mealTime = document.getElementById('time').value;
                const foodName = document.getElementById('newInput').value;
                const quantity = document.getElementById('quantity').value;
        
                fetch('/api/meal/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({
                        meal_type: mealType,
                        time: mealTime,
                        name_of_food: foodName,
                        quantity: quantity
                    })
                }).then(response => {
                    if (response.ok) {
                        alert('Приём пищи успешно добавлен');
                    } else {
                        alert('Ошибка при добавлении приёма пищи');
                    }
                });
            });
        });
    </script>



    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login/';
                return;
            }
        
            fetch('/api/profile/', {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            }).then(response => response.json())
              .then(data => {
                  document.getElementById('username').textContent = data.username;
                  document.getElementById('email').textContent = data.email;
                  document.getElementById('date_of_birth').textContent = data.date_of_birth;
                  document.getElementById('goal').textContent = data.goal;
                  document.getElementById('gender').textContent = data.gender;
                  document.getElementById('vegan_vegetarian').textContent = data.vegan_vegetarian;
                  document.getElementById('allergies').textContent = data.allergies;
                  document.getElementById('weight').textContent = data.weight;
                  document.getElementById('height').textContent = data.height;
        
                  var currentTime = new Date();
                  var formattedTime = currentTime.toLocaleTimeString();
                  document.getElementById('additional_text_input').value = "Дата моего рождения: " + data.date_of_birth + ". Мой пол: " + data.gender + ". Мой вес: " + data.weight + ". Мой рост: " + data.height + ". Моя цель: " + data.goal + ". Мой образ питания: " + data.vegan_vegetarian + ". Я не предпочитаю эти продукты: " + data.allergies + ". И сейчас время: " + formattedTime;
              });

              document.getElementById('logout_btn').addEventListener('click', function() {
                const refreshToken = localStorage.getItem('refresh');
            
                fetch('/api/logout/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({
                        'refresh': refreshToken
                    })
                }).then(response => {
                    if (response.status === 205) {
                        localStorage.removeItem('token');
                        localStorage.removeItem('refresh');
                        window.location.href = '/';
                    } else {
                        alert('Error logging out');
                    }
                });
            });
        });
    </script>

    <script>
        document.getElementById('save-info-btn').addEventListener('click', function() {
            const token = localStorage.getItem('token');
        
            const data = {
                email: document.getElementById('email-input').value,
                date_of_birth: document.getElementById('date_of_birth-input').value,
                goal: document.getElementById('goal-input').value,
                gender: document.getElementById('gender-input').value,
                vegan_vegetarian: document.getElementById('vegan_vegetarian-input').value,
                allergies: document.getElementById('allergies-input').value,
                weight: document.getElementById('weight-input').value,
                height: document.getElementById('height-input').value
            };
        
            fetch('/api/update-profile/', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify(data)
            }).then(response => response.json())
              .then(data => {
                  if (data) {
                      document.getElementById('username').textContent = data.username;
                      document.getElementById('email').textContent = data.email;
                      document.getElementById('date_of_birth').textContent = data.date_of_birth;
                      document.getElementById('goal').textContent = data.goal;
                      document.getElementById('gender').textContent = data.gender;
                      document.getElementById('vegan_vegetarian').textContent = data.vegan_vegetarian;
                      document.getElementById('allergies').textContent = data.allergies;
                      document.getElementById('weight').textContent = data.weight;
                      document.getElementById('height').textContent = data.height;
        
                      document.querySelectorAll('.edit-input').forEach(input => {
                          input.style.display = 'none';
                      });
                      document.querySelectorAll('.personal_info_subblock span').forEach(span => {
                          span.style.display = 'inline-block';
                      });
                      document.getElementById('edit-info-btn').style.display = 'inline-block';
                      document.getElementById('save-info-btn').style.display = 'none';
                      document.getElementById('cancel-edit-btn').style.display = 'none';
                  } else {
                      alert('Error updating profile');
                  }
            });
        });
    </script>
</body>
<script src="{% static "script_main.js" %}" defer></script>
</html>